<extend name="Common:base"/>

<block name="page_title">发布促销</block>
<block name="main">
    <div class="box">
        <div class="box-header well-small">
            <h4>发布商品促销</h4>
        </div>
        <div class="box-content">
            <form class="form-horizontal" action="{:U('promotions/insert')}" method="post">
                <fieldset>
                    <legend>促销信息<a href="{:U('promotions/index')}" class="btn btn-info pull-right">返回促销商品列表</a></legend>
                    <input type="hidden" name="branch_id" value="{$branch.id}"/>
                    <empty name="goods">
                        <input type="hidden" name="goods_id" value="{$goods.id}"/>
                        <else/>
                        <input type="hidden" name="goods_id"/>
                    </empty>

                    <div class="control-group">
                        <label class="control-label">促销条码</label>
                        <div class="controls">
                            <input type="text" name="barcode" /><a id="getGoodsInfo" class="btn">获取商品信息</a>
                        </div>
                    </div>

                    <div class="control-group">
                        <div id="goodsInfo" style="display: none">
                            <table class="table table-striped table-bordered table-hover">
                                <thead>
                                <td>名称</td>
                                <td>分类</td>
                                <td>规格</td>
                                <td>单位</td>
                                <td>原售价</td>
                                <td>报警数</td>
                                <td>品牌</td>
                                <td>关键词</td>
                                <td>描述信息</td>
                                </thead>
                                <tbody>
                                <tr id="goodslist">

                                </tr>
                                </tbody>
                            </table>

                        </div>
                    </div>


                    <div class="control-group">
                        <label class="control-label">折扣</label>
                        <div class="controls">
                            <input  type="text" name="discount"/>

                                <span>折</span>
                        </div>
                    </div>

                     <div class="control-group">
                        <label class="control-label">开始时间</label>
                        <div class="controls ">
                            <div class="datetimepicker input-append">
                                <input data-format="yyyy-MM-dd hh:mm:ss" name="time_start"  type="text"/>
                                <span class="add-on">
                                    <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                     <div class="control-group">
                        <label class="control-label">结束时间</label>
                        <div class="controls">
                            <input type="text" name="time_end" class="datetimepicker"/>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">确定</button>
                        <button type="reset" class="btn">重置</button>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
</block>


<block name="other">
    <js href="__ASSETS__/plugins/scanner/scanner.js" />
    <script type="text/javascript">
        $(function(){
            var scanner  = new Scanner("webcam",function(code){
                $('input[name="barcode"]').val(code);
                showTips("识别到条形码<strong>"+code+"</strong>，请录入商品数量并添加到入库商品清单。");
                //防止重复添加
                if(isScanned(code)){
                    showTips("<strong>注意！</strong>条形码："+code+"已经添加过！");
                }else{
                    $.get('{:U("StockGoods/getInfo")}',{"barcode":code},function(json){
                        if(json.status == 0){
                            showTips("找不到条形码"+code+"的商品信息！");
                            $('#goods_name').addClass("noinfo").html("");
                        }else{
                            $('#goods_name').removeClass("noinfo").html(json.data.name);
                        }
                    });
                }
            });

            $("#getGoodsInfo").on("click",function(){
                var code = $("input[name='barcode']").val();
                $.get('{:U("StockGoods/getInfo")}',{"barcode":code},function(json){
                    if(json.status == 0){
                        showTips("找不到条形码"+code+"的商品信息！");
                        $('#goods_name').addClass("noinfo").html("");
                    }else{
                        //将商品id传递到页面中
                        $("input[name='goods_id']").val(json.data["id"]);
                        /* console(json.data);*/
                        var list  = " <td>"+json.data["name"]+"</td>"+
                                " <td>"+json.data["category_id"]+"</td>"+
                                " <td>"+json.data["specifications"]+"</td>"+
                                " <td>"+json.data["unit"]+"</td>"+
                                " <td>￥"+json.data["sales_price"]+"</td>"+
                                " <td>"+json.data["alarm"]+"</td>"+
                                " <td>"+json.data["brand"]+"</td>"+
                                " <td>"+json.data["keyword"]+"</td>"+
                                " <td>"+json.data["desp"]+"</td>";

                        $("#goodslist").html(list);

                        $('#goodsInfo').removeClass("noinfo").show();
                    }
                });

            });

            var codes = [];
            function isScanned(code){
                for(var i = 0,len=codes.length; i< len; i++){
                    if(codes[i] === code){
                        return true;
                    }
                }
                return false;
            }

            function showTips(msg){
                $("#formtips").html(msg);
            }

        });
    </script>

</block>